# 媒体内容管理系统 - 设备授权保护系统

## 问题描述

原系统存在授权验证漏洞，用户可以通过卸载重装软件重复使用同一授权码，导致授权码被滥用。

## 解决方案

实现了一个防卸载重装授权保护系统，包含以下核心功能：

1. **设备唯一ID生成**：通过收集多种硬件信息生成唯一设备ID
2. **多位置授权记录存储**：在注册表、用户目录和程序目录多个位置存储加密的授权记录
3. **启动验证流程**：程序启动时验证设备ID与授权记录匹配
4. **授权码管理系统**：支持管理员管理和监控授权码，防止滥用

## 技术实现

### 1. 设备唯一ID生成

通过收集以下硬件信息生成设备唯一ID：
- Windows MachineGuid
- CPU信息
- 主板信息
- 网络MAC地址
- 计算机名和用户名
- Windows安装ID
- 硬盘序列号
- 显卡信息
- 系统盘卷标

使用SHA-256和MD5算法生成主ID和备用ID，确保ID的唯一性和稳定性。

### 2. 授权记录存储

授权记录包含以下信息：
- 授权码
- 设备ID
- 授权时间
- 版本信息

存储位置：
- **注册表**：多个随机命名的注册表项
- **文件系统**：用户目录下的多个隐藏位置
- **程序目录**：程序安装目录下的隐藏文件
- **临时目录**：作为备用存储位置

所有存储的数据都经过加密处理，使用基于授权码的密钥进行XOR加密和Base64编码。

### 3. 启动验证流程

程序启动时执行以下验证步骤：
1. 检查授权系统完整性
2. 获取当前设备ID
3. 检查授权码是否有效
4. 在多个位置查找授权记录
5. 比对授权记录中的设备ID与当前设备ID
6. 如果设备ID不匹配，判定为卸载重装行为，授权失效

### 4. 授权码管理系统

管理员可以通过以下方式管理授权码：

**管理功能**：
- 支持批量管理授权码
- 记录操作原因和时间
- 管理后授权码状态变更
- 自动从授权码池和数据库中更新

**解除功能**：
- 支持批量解除授权码限制
- 解除后授权码可重新使用
- 自动恢复到授权码池

**管理工具**：
- 命令行管理工具
- Windows批处理界面
- 服务器状态监控
- 操作记录查看和管理

## 改进和修复

### 1. 权限问题修复

- 添加多级备用存储路径，解决权限不足问题
- 使用用户目录和临时目录作为备用存储位置
- 改进错误处理，确保至少有一个位置能成功存储

### 2. 加密/解密功能增强

- 改进解密函数的错误处理
- 添加对损坏数据的处理
- 支持多种数据格式（JSON、加密文本）

### 3. 授权验证流程优化

- 添加详细的日志记录
- 改进错误处理，防止单点故障
- 增加对旧版本升级的兼容处理

## 使用说明

1. 程序首次授权时，会生成设备唯一ID并存储授权记录
2. 如果用户卸载重装程序，新安装的程序会检测到设备ID与授权记录匹配，允许继续使用
3. 如果用户在不同设备上使用同一授权码，会被检测到并拒绝授权

### 授权码管理

**命令行方式**：
```bash
# 查看服务器状态
python manager.py status

# 查看管理列表
python manager.py list

# 管理授权码
python manager.py manage CODE-ABC123 CODE-DEF456

# 解除授权码
python manager.py release CODE-ABC123

# 清空管理列表
python manager.py clear
```

**Windows图形界面**：
双击运行管理工具文件，按照菜单提示操作。

**注意事项**：
- 管理后的授权码将受到限制
- 解除后的授权码可以重新使用
- 管理操作会记录操作员和时间
- 建议在操作前先查看授权码的使用情况

## 测试方法

使用提供的测试脚本验证系统功能：

```bash
python test_system.py
```

测试内容包括：
1. 设备ID生成
2. 授权记录保存
3. 授权记录检查
4. 配置文件读写

## 注意事项

- 授权记录存储在多个位置，确保系统安全性
- 所有存储的数据都经过加密处理
- 系统会记录异常使用行为到日志文件
- 仅供学习和研究使用，请遵守相关法律法规

## 免责声明

本项目仅供学习和研究使用。使用本软件时，请遵守相关法律法规和服务条款。作者不承担任何法律责任。